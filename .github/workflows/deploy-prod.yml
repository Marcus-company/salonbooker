name: Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "deploy" to confirm production deployment'
        required: true
        type: string

env:
  NODE_VERSION: '20'

jobs:
  # ============================================
  # Job 1: Confirm Deployment
  # ============================================
  confirm:
    name: Confirm Production Deployment
    runs-on: ubuntu-latest
    
    steps:
      - name: Check confirmation
        if: github.event.inputs.confirm != 'deploy'
        run: |
          echo "‚ùå Deployment not confirmed"
          echo "Please run with confirm='deploy'"
          exit 1
      
      - name: Confirm deployment
        run: echo "‚úÖ Production deployment confirmed"

  # ============================================
  # Job 2: Full Test Suite
  # ============================================
  test-suite:
    name: Full Test Suite
    runs-on: ubuntu-latest
    needs: confirm
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run all tests
        run: npm run test
        continue-on-error: false

  # ============================================
  # Job 3: Security Scan
  # ============================================
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: test-suite
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run npm audit
        run: npm audit --audit-level=high
        continue-on-error: true
      
      - name: Check for secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD
          extra_args: --debug --only-verified
        continue-on-error: true

  # ============================================
  # Job 4: Deploy to Production
  # ============================================
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [test-suite, security-scan]
    environment:
      name: production
      url: https://hairsalonx.nl
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build for production
        run: npm run build
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.PROD_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.PROD_SUPABASE_ANON_KEY }}
          NEXT_PUBLIC_APP_URL: https://hairsalonx.nl
          NODE_ENV: production
      
      - name: Create deployment package
        run: |
          mkdir -p deploy
          cp -r .next deploy/
          cp -r public deploy/
          cp package*.json deploy/
          cp next.config.* deploy/ 2>/dev/null || true
          tar -czf deploy.tar.gz deploy/
      
      - name: Deploy to Vercel (Production)
        uses: vercel/action-deploy@v1
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          vercel-args: '--prod'
        continue-on-error: true
      
      - name: Deploy notification (fallback)
        if: failure()
        run: |
          echo "‚ö†Ô∏è Vercel deploy failed or not configured"
          echo "Manual deployment required"

  # ============================================
  # Job 5: Post-deployment Verification
  # ============================================
  verify:
    name: Verify Production Deployment
    runs-on: ubuntu-latest
    needs: deploy
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq
      
      - name: Wait for deployment
        run: sleep 60
      
      - name: Run production smoke tests
        run: |
          PROD_URL="https://hairsalonx.nl"
          
          echo "Testing production health..."
          for i in {1..5}; do
            response=$(curl -s -o /dev/null -w "%{http_code}" "$PROD_URL/api/health")
            if [ "$response" = "200" ]; then
              echo "‚úÖ Production is healthy!"
              exit 0
            fi
            echo "Attempt $i: Status $response, retrying..."
            sleep 10
          done
          
          echo "‚ùå Production health check failed"
          exit 1
      
      - name: Notify deployment success
        run: |
          echo "üéâ Production deployment successful!"
          echo "üîó URL: https://hairsalonx.nl"
          echo "üìù Commit: ${{ github.sha }}"
